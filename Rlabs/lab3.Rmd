---
title: "Intro to Tidycensus"
author: "Marcelino Guerra"
date: "Last update: 2/25/2021"
abstract: 
output: 
  rmdformats::downcute
---

<style type="text/css">
  body{
  font-size: 13pt;
}
</style>

```{r setup, include=FALSE}
  knitr::opts_chunk$set(include = TRUE)  # TRUE for solution; FALSE for questions set
  knitr::opts_chunk$set(echo = TRUE)
  knitr::opts_chunk$set(message = FALSE)
  knitr::opts_chunk$set(warning = FALSE)
  knitr::opts_chunk$set(fig.height = 7, fig.width = 11, out.width = '100%', fig.align = "center")
  options(width = 90)
library(fontawesome)
``` 


## Tidycensus

Tidycensus is an `r fa("r-project", fill = "steelblue")` package that allows for interfacing with the US Census Bureau's data. Using the function `get_decennial()`, you have access to the 2000 and 2010 decennial US Census, and using `get_acs()`, you can get data from the 1-year and 5-year American Community Survey.  

To get started with `tidycensus`, you need to install the package and set a Census API key. Use this link [(here)](https://api.census.gov/data/key_signup.html) to request a key. You can use "University of Illinois at Urbana-Champaign" as an organization and your student account (@illinois.edu) as an email address. After that, use `census_api_key("your_api_number_goes_here", install =TRUE)` and you are set. 

Let's examine the variables in the American Community Survey 5-year estimates (`acs5`) for 2018. 

 
```{r, include=T}
library(tidyverse)
library(tidycensus)
### Get your Census API key and apply the function census_api_key
#census_api_key("put_your_key_here", install =TRUE)
variables<- load_variables(year = 2019, dataset = "acs5")
head(variables)
```

Working with `tidycensus`, you can get data from a collection of geographies - state, county, block, tract, etc. Here we work with ACS data from census tracts in Cook County-IL in 2015-2019. All the variables have a specific code, and you might want to come back to `variables` to check what is available and what code corresponds to what variables. Note that `get_acs()` returns two columns: estimate and margin of error.       

```{r, include=T}
chi_data <- get_acs(geography = "tract", 
                    state="IL", 
                    county = "Cook County", 
                    year=2018, 
                    dataset="acs5", 
                    output = "wide", 
                    variables=c(medincome="B19013_001",housevalue="B25077_001"))
head(chi_data)
```
The `E` after the variable's name corresponds to "estimate" - that is the value we are looking for. The `M` after the variable's name refers to the margin of error - [here](https://www.census.gov/programs-surveys/acs/guidance/training-presentations/acs-moe.html) you have more info about the moe. With the following code, you get a scatter plot of median household income and median home value for census tracts in Cook County-IL. 

```{r, include=T}
library(ggthemes)
library(ggrepel)

ggplot(chi_data, aes(x=medincomeE, y=housevalueE)) + 
  geom_point(color="#6794a7", size=3,alpha=.7) + 
  stat_smooth(method = "lm", formula =y~x, se=F,  colour="#014d64") +
  scale_x_continuous(name = "Median Household Income") +
  scale_y_continuous(name = "Median Home Value") +
  theme_economist(base_size = 17)+
  theme(axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        panel.grid.major.x = element_line( size=.05, color="white"))
```

Now, let's get information about median rent as a percentage of household income by **state** in 2005-2009. First, load the ACS 2005-2009 variables: 

```{r}
var09<- load_variables(year = 2009, dataset = "acs5")
```

Knowing the variable's code, you can easily import the information you want and make a table, for instance. As you can see, in the period 2005-2009, Florida had the highest value for the median gross rent as a share of household income:   

```{r}
state09<-get_acs(geography = "state", 
                 variables = c(rent_income="B25071_001"), 
                 dataset="acs5",
                 output="wide",
                 year=2009)
state09%>%select(NAME, rent_incomeE)%>%arrange(desc(rent_incomeE))%>%slice(1:10)
```

Did those values change a lot? Let's check these numbers for the period 2015-2019:

```{r}
state19<-get_acs(geography = "state", 
                 variables = c(rent_income="B25071_001"), 
                 dataset="acs5",
                 output="wide",
                 year=2019)
state19%>%select(NAME, rent_incomeE)%>%arrange(desc(rent_incomeE))%>%slice(1:10)
```

Finally, let's see population growth in US states over the period 2000-2010. This time, we use Census data `get_decennial()`. The variable code that corresponds to `Total Population` is `P001001`. We get that info for 2000 and 2010, and merge the two data frames. After that, we calculate the growth rate and arrange the data to see the top and bottom five states in terms of population growth between those years.  

```{r}
state_pop00<-get_decennial(geography = "state",
                         variables=c(pop00="P001001"),
                         output="wide",
                         year=2000)

state_pop10<-get_decennial(geography = "state",
                         variables=c(pop10="P001001"),
                         output="wide",
                         year=2010)

state_pop<-left_join(state_pop00, state_pop10, by=c("NAME","GEOID"))

state_pop$pop_growth<-(state_pop$pop10-state_pop$pop00)/state_pop$pop00*100
### TOP 5
state_pop%>%select(NAME, pop_growth)%>%arrange(desc(pop_growth))%>%slice(1:5)
### BOTTOM 5
state_pop%>%select(NAME, pop_growth)%>%arrange(pop_growth)%>%slice(1:5)
```

